# -*- coding: utf-8 -*-
"""dataset.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1xFQpwkzeaf2ST84LMgTzMCl6Zh_cqsfA
"""

import torch
from torch_geometric.data import Data, Dataset
import numpy as np
import os

class LiDARSegDataset(Dataset):
  def __init__(self, root, split='train', num_points=1024, transform=None, pre_transform=None):
    super().__init__(root, transform, pre_transform)
    self.split = split
    self.files = [f for f in os.listdir(os.path.join(root,split)) if f.endswith('.npz') ]
    self.num_points = num_points

  def len(self):
    return len(self.files)

  def __getitem__(self, idx):

    data_path =  os.path.join(self.root, self.split, self.files[idx])
    npz = np.load(data_path)
    pos = torch.tensor(npz['xyz'], dtype=torch.float).T
    x = torch.tensor(npz['features'], dtype=torch.float)
    y = torch.tensor(npz['labels'], dtype=torch.long)
    
    # Downsample points if too many
    N = self.num_points
    num_points_in_cloud = pos.size(0)
    if num_points_in_cloud > N:
       perm = torch.randperm(num_points_in_cloud)[:N] 
       pos = pos[perm]
       x = x[perm]
       y = y[perm]
        
    return Data(x=x, pos=pos, y=y)